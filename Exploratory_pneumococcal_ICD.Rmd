---
title: "Exploratory"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
source('./R/death_plot_fun.R')
source('./R/Format_US_Population.R')
```

```{r}
pneumo.deaths <-   readRDS('./Data/pneumococcal_deaths_line_list.rds')

pneumo.deaths$agec <- factor(pneumo.deaths$agec, c("Under 5 Years",'5-24 years', "25-44 years","45-64 years","65-74 years" ,"75-84 years","85 years and older"))

pneumo.deaths$race_recode <- factor(pneumo.deaths$race_recode, levels=c(1,2,3,4,5), c('White','Black','Hispanic','American Indian', 'Asian/Pacific Islanders')) 
```

Popsize data
```{r}
#Format_US_Population()
pop1 <- readRDS('./Data/pop_interpol.rds')

pop2 <- pop1 %>%
  group_by(date, agec, race_recode) %>%
  summarize(pop.interpol= sum(pop.interpol)) %>%
  mutate(race_recode= factor(race_recode,levels=c(1,2,3,4,5), c('White','Black','Hispanic','American Indian', 'Asian/Pacific Islanders')))
```


```{r}
sort(table(pneumo.deaths$icd1), decreasing=T)[1:100]
```

```{r}
sort(table(pneumo.deaths$icd2), decreasing=T)[1:100]
```

```{r}
p1 <- death_plot_fun(year,month)
p1$plot1
```

```{r}
p2 <- death_plot_fun(year,month, agec) 
p2$plot1 + facet_wrap(~agec, scales='free')
```
Note; big differences in age distribution. Hispanic skews much younger
```{r}
p3 <- death_plot_fun(year,month, race_recode) 
p3$plot1+ facet_wrap(~race_recode, scales='free')
```


Age of deaths, by race/ethnicity. The proportion of deaths among kids is much higher for Black and Hispanic populations. need to look at incidence by age
```{r}
 p1 <- ggplot(pneumo.deaths, aes(x=agey))+
  geom_histogram() +
  theme_classic() +
  facet_wrap(~race_recode, scales='free_y')
p1
```
```{r}
p3 <- death_plot_fun(year,month, race_recode, agec) 

p3$ts$date <- as.Date(paste(p3$ts$year, p3$ts$month, '01',sep='-') , '%Y-%m-%d' )


p3.ds <- merge(p3$ts, pop2, by=c('agec','race_recode', 'date')) %>%
  group_by(race_recode, agec) %>%
  summarize(N_deaths=sum(N_deaths), pop=mean(pop.interpol))%>%
  ungroup() %>%
  mutate(inc=N_deaths/pop*100000 , race_recode=factor(race_recode)) 

ggplot(p3.ds, aes(x=agec, y=log(inc), group=race_recode,col=race_recode)) +
  geom_line()+
  theme_classic()+
  ggtitle('Rate of death by age and race/ethnicity')+
   theme(axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1)) +
  ylab('Deaths/100,000') +
  xlab('')
```


